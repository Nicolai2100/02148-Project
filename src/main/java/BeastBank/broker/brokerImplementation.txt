Client sends an order package:
    p0.put(pkg);

Detect change in stock rates:
    //Some logic that querys p5 for waiting packages
    //and makes a list of all the id's of the packages, that
    //needs to be notified.
    p6.put(idsOfpackagesToNotify)

Receive new order package:
    while(true) {
        pkg = p0.get(pkg);
        p1.put(pkg);

        //Some logic that querys p5 for waiting packages
        //and makes a list of all the id's of the packages, that
        //needs to be notified.

        if (idsOfpackagesToNotify.isEmpty()) {
            p6.put("noPackagesToNotify");
        } else {
            p6.put(idsOfpackagesToNotify);
        }
    }

Get next package and lock:
    while(true) {
        pkg = p1.get(pkg);
        p2.get("lock");
        p3.put(pkg);
    }

Try to find enough matches:
    while(true) {
        pkg = p3.get(pkg);
        //Business logic that tries to find enough matches
        //for the orders in the package.
        //Puts a boolean with the result along with the package
        //in the next space, p4.
        p4.put(pkg, enoughMatchesFound);
    }

Remove orders and signal bank to make transactions:
    while(true) {
        //Only gets a package from p4 if the boolean in the tuple is true.
        p4.get(pkg, true);
        //Signal bank to make transactions here.
        p2.put("lock");
    }

Signal waiting for new orders or rates:
    while(true) {
        //Only gets a package from p4 if the boolean in the tuple is false.
        pkg = p4.get(pkg, false)[0];
        p5.put(pkg, pkg.getID());
        p2.put("lock");
    }

Notify waiting package:
    while(true) {
        List ids = p6.get(idsOfpackagesToNotify);
        idOfpkgToNotify = ids.remove(0);
        p7.put(idOfpkgToNotify);
        if (ids.isEmpty()) {
            p6.put("noPackagesToNotify");
        } else {
            p6.put(ids);
        }
    }

No waiting packages to notify:
    while(true) {
        p6.get("noPackagesToNotify");
    }

Put package back in queue:
    while (true) {
        p7.get(idOfpkgToNotify);
        pkg = p5.get(pkg, idOfpkgToNotify)[0];
        p1.put(pkg);
    }
